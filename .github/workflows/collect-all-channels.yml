name: Build all.channels.xml

on:
  workflow_dispatch:
  schedule:
    - cron: "0 0 * * *"

permissions:
  contents: write

concurrency:
  group: all-channels-xml
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install xmllint (libxml2-utils)
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends libxml2-utils

      - name: Build combined all.channels.xml
        shell: bash
        run: |
          set -euo pipefail

          # Collect all *.channels.xml files under ./sites (robust to spaces/newlines)
          mapfile -d '' -t FILES < <(find sites -type f -name '*.channels.xml' -print0 | sort -z)

          if (( ${#FILES[@]} == 0 )); then
            echo "No *.channels.xml files found under ./sites — nothing to do."
            exit 0
          fi

          TMP="$(mktemp)"

          # Start the combined XML with a single <channels> root
          {
            printf '%s\n' '<?xml version="1.0" encoding="UTF-8"?>'
            printf '%s\n' '<channels>'
            for f in "${FILES[@]}"; do
              # Extract all <channel> nodes from each file
              if out="$(xmllint --xpath '//channels/channel' "$f" 2>/dev/null)"; then
                printf '%s\n' "$out"
              else
                echo "WARN: Could not parse or no <channel> nodes found in: $f" >&2
              fi
            done
            printf '%s\n' '</channels>'
          } > "$TMP"

          # Pretty-print and write to the repository root
          xmllint --format "$TMP" -o all.channels.xml

          # Count channels for commit message
          CHANNEL_COUNT="$(grep -o '<channel[^>]*>' all.channels.xml | wc -l | tr -d '[:space:]')"
          echo "Generated all.channels.xml with ${CHANNEL_COUNT} channel entries."

          # Commit only if there are changes
          if git diff --quiet -- all.channels.xml 2>/dev/null; then
            echo "No changes to all.channels.xml — skipping commit."
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add all.channels.xml
          git commit -m "chore: update all.channels.xml (${CHANNEL_COUNT} channels)"
          git push
